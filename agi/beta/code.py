# agi

```json
{
    "files": [
        {
            "filename": "security_engine.py",
            "content": "# security_engine.py\n# 安全工程师实现的AGI安全控制模块\n# 用于确保使用OpenAI API的AGI系统符合安全最佳实践\n\nimport os\nimport logging\nfrom typing import Dict, Any, Optional\nimport requests\nfrom datetime import datetime, timedelta\nimport hashlib\nimport json\nfrom dotenv import load_dotenv\n\n# 加载环境变量\nload_dotenv()\n\n# 配置日志\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\nclass SecurityEngine:\n    \"\"\"\n    安全引擎：负责AGI系统的安全控制、监控和防护\n    \"\"\"\n    \n    def __init__(self):\n        self.api_key = os.getenv('OPENAI_API_KEY')\n        self.allowed_domains = [\n            'api.openai.com',\n            'openai.com'\n        ]\n        self.rate_limit_window = 60  # 秒\n        self.max_requests_per_window = 10\n        self.request_history = {}\n        self.session = requests.Session()\n        self.session.headers.update({\n            'Authorization': f'Bearer {self.api_key}',\n            'Content-Type': 'application/json'\n        })\n        \n    def validate_api_key(self) -> bool:\n        \"\"\"\n        验证API密钥是否存在且有效\n        \"\"\"\n        if not self.api_key:\n            logger.error(\"API密钥未配置\")\n            return False\n        \n        # 简单的API密钥格式验证\n        if len(self.api_key.strip()) < 10:\n            logger.error(\"API密钥格式不正确\")\n            return False\n        \n        return True\n    \n    def sanitize_input(self, input_data: str) -> str:\n        \"\"\"\n        对输入数据进行安全清理，防止注入攻击\n        \"\"\"\n        if not input_data or not isinstance(input_data, str):\n            return \"\"\n        \n        # 基本的XSS过滤\n        dangerous_patterns = [\n            '<script>',\n            'javascript:',\n            'vbscript:',\n            'data:text/html;'\n        ]\n        \n        for pattern in dangerous_patterns:\n            if pattern in input_data.lower():\n                logger.warning(f\"检测到潜在危险输入: {pattern}\")\n                return \"\"\n        \n        # 转义特殊字符\n        sanitized = input_data.replace('&', '&amp;')\n        sanitized = sanitized.replace('<', '&lt;')\n        sanitized = sanitized.replace('>', '&gt;')\n        sanitized = sanitized.replace('\"', '&quot;')\n        \n        return sanitized\n    \n    def validate_request_rate(self, user_id: str) -> bool:\n        \"\"\"\n        检查用户请求频率是否超过限制\n        \"\"\"\n        now = datetime.now()\n        window_start = now - timedelta(seconds=self.rate_limit_window)\n        \n        # 清理过期的请求记录\n        self.request_history[user_id] = [\n            req for req in self.request_history.get(user_id, [])\n            if req > window_start\n        ]\n        \n        # 检查是否超出限制\n        if len(self.request_history[user_id]) >= self.max_requests_per bucket):\n            logger.warning(f\"用户 {user_id} 请求频率过高\")\n            return False\n        \n        # 记录本次请求\n        self.request_history.setdefault(user_id, []).append(now)\n        return True\n    \n    def validate_domain(self, domain: str) -> bool:\n        \"\"\"\n        验证目标域名是否在允许列表中\n        \"\"\"\n        if not domain or not isinstance(domain, str):\n            return False\n        \n        return domain in self.allowed_domains\n    \n    def log_security_event(self, event_type: str, details: Dict[str, Any]) -> None:\n        \"\"\"\n        记录安全事件\n        \"\"\"\n        event = {\n            'timestamp': datetime.now().isoformat(),\n            'event_type': event_type,\n            'details': details,\n            'source_ip': details.get('source_ip', 'unknown'),\n            'user_id': details.get('user_id', 'unknown')\n        }\n        \n        # 写入安全日志\n        with open('security_log.jsonl', 'a') as f:\n            f.write(json.dumps(event) + '\\n')\n        \n        logger.info(f\"安全事件: {event_type}\", extra=details)\n    \n    def secure_api_call(self, endpoint: str, payload: Dict[str, Any], user_id: str) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        执行安全的API调用\n        \"\"\"\n        # 验证API密钥\n        if not self.validate_api_key():\n            self.log_security_event('API_KEY_INVALID', {'user_id': user_id})\n            return None\n        \n        # 验证请求频率\n        if not self.validate_request_rate(user_id):\n            self.log_security_event('RATE_LIMIT_EXCEEDED', {'user_id': user_id})\n            return None\n        \n        # 验证域名\n        domain = endpoint.split('//')[1].split('/')[0] if '//' in endpoint else endpoint\n        if not self.validate_domain(domain):\n            self.log_security_event('DOMAIN_BLOCKED', {'domain': domain, 'user_id': user_id})\n            return None\n        \n        # 清理输入\n        if 'prompt' in payload:\n            payload['prompt'] = self.sanitize_input(payload['prompt'])\n            \n        try:\n            response = self.session.post(\n                f'https://{endpoint}',\n                json=payload\n            )\n            \n            if response.status_code == 200:\n                result = response.json()\n                self.log_security_event('API_CALL_SUCCESS', {\n                    'endpoint': endpoint,\n                    'user_id': user_id,\n                    'request_size': len(str(payload))\n                })\n                return result\n            else:\n                self.log_security_event('API_CALL_FAILED', {\n                    'endpoint': endpoint,\n                    'status_code': response.status_code,\n                    'user_id': user_id\n                })\n                return None\n        \n        except Exception as e:\n            self.log_security_event('API_CALL_EXCEPTION', {\n                'error': str(e),\n                'user_id': user_id\n            })\n            return None\n    \n    def monitor_for_suspicious_activity(self, activity_log: Dict[str, Any]) -> bool:\n        \"\"\"\n        监控可疑活动\n        \"\"\"\n        suspicious_patterns = [\n            'delete database',\n            'drop table',\n            'exec system',\n            'shutdown server'\n        ]\n        \n        content = activity_log.get('content', '').lower()\n        \n        for pattern in suspicious_patterns:\n            if pattern in content:\n                self.log_security_event('SUSPICIOUS_ACTIVITY_DETECTED', {\n                    'pattern': pattern,\n                    'content': content,\n                    'user_id': activity_log.get('user_id')\n                })\n                return True\n        \n        return False\n\n# 使用示例\nif __name__ == \"__main__\":\n    # 创建安全引擎实例\n    security_engine = SecurityEngine()\n    \n    # 示例API调用\n    payload = {\n        \"model\": \"gpt-3.5-turbo\",\n        \"messages\": [\n            {\n                \"role\": \"user\",\n                \"content\": \"你好，这是一个测试消息\"\n            }\n        ],\n        \"temperature\": 0.7\n    }\n    \n    result = security_engine.secure_api_call(\n        \"api.openai.com/v1/chat/completions\",\n        payload,\n        \"user_123\"\n    )\n    \n    if result:\n        print(\"API调用成功\")\n        print(result)\n    else:\n        print(\"API调用失败\")"
        },
        {
            "filename": "config.py",
            "content": "# config.py\n# AGI项目配置文件\n\nimport os\nfrom typing import Dict, Any\n\n# OpenAI API配置\nOPENAI_API_KEY = os.getenv('OPENAI_API_KEY')\nOPENAI_BASE_URL = os.getenv('OPENAI_BASE_URL', 'https://api.openai.com')\n\n# 安全配置\nSECURITY_LOG_FILE = 'security_log.jsonl'\nMAX_REQUESTS_PER_MINUTE = 10\nALLOWED_DOMAINS = [\n    'api.openai.com',\n    'openai.com'\n]\n\n# AGI系统配置\nAGI_MODELS = {\n    'default': 'gpt-3.5-turbo',\n    'advanced': 'gpt-4',\n    'vision': 'gpt-4-vision-preview'\n}\n\n# 用户权限配置\nUSER_PERMISSIONS = {\n    'basic': ['read', 'write'],\n    'premium': ['read', 'write', 'analyze'],\n    'admin': ['read', 'write', 'analyze', 'manage']\n}\n\n# 环境配置\nENVIRONMENT = os.getenv('ENVIRONMENT', 'development')\n\n# 日志配置\nLOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO').upper()\nLOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n\n# 其他配置\nTIMEOUT_SECONDS = 30\nRETRY_ATTEMPTS = 3\n\n# 配置字典\nCONFIG: Dict[str, Any] = {\n    'openai': {\n        'api_key': OPENAI_API_KEY,\n        'base_url': OPENAI_BASE_URL\n    },\n    'security': {\n        'log_file': SECURITY_LOG_FILE,\n        'max_requests_per_minute': MAX_REQUESTS_PER_MINUTE,\n        'allowed_domains': ALLOWED_DOMAINS\n    },\n    'agi': {\n        'models': AGI_MODELS,\n        'permissions': USER_PERMISSIONS\n    },\n    'environment': ENVIRONMENT,\n    'logging': {\n        'level': LOG_LEVEL,\n        'format': LOG_FORMAT\n    },\n    'timeout': TIMEOUT_SECONDS,\n    'retry_attempts': RETRY_ATTEMPTS\n}"
        },
        {
            "filename": "requirements.txt",
            "content": "requests==2.31.0\npython-dotenv==0.21.0\npydantic==2.0.0\nfastapi==0.100.0\nuvicorn==0.22.0\npython-jwt==2.8.0\nbcrypt==4.0.1\nsqlalchemy==2.0.0\nredis==5.0.0\npycryptodome==3.20.0\npytest==7.4.0\nflake8==6.0.0\nblack==23.3.0"
        }
    ]
}
```