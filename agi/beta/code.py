# agi

{
    "files": [
        {
            "filename": "agi/architecture/design.md",
            "content": "# AGI 系统架构设计文档\n\n## 1. 概述\n本项目旨在构建一个具备通用认知能力的AGI（Artificial General Intelligence）系统，基于模块化、可扩展、可验证的设计原则，利用OpenAI API作为核心推理引擎，并通过多层抽象实现感知-推理-行动闭环。\n\n## 2. 核心设计原则\n- **分层解耦**：感知层、认知层、决策层、执行层分离\n- **记忆增强**：支持长期记忆（向量数据库）与短期工作记忆（上下文管理）\n- **自我反思机制**：内置元认知模块用于评估、修正与学习\n- **安全对齐**：符合 Constitutional AI 与 RLHF 原则，内置价值对齐校验器\n- **可扩展插件化**：支持外部工具调用（Tool Calling）与动态知识注入\n\n## 3. 系统架构图（文字描述）\n```\n+------------------+     +---------------------+     +--------------------+\n|   Perception     | --> |   Cognitive Engine  | --> |   Action Executor  |\n| - Multi-modal I/O|     | - Reasoning Core    |     | - Tool Orchestrator|\n| - Event Stream   |     | - Memory Manager    |     | - Output Formatter |\n+------------------+     | - Self-Reflection   |     +--------------------+\n                           +----------+----------+\n                                      |\n                           +----------v----------+\n                           |   Value Alignment |\n                           |   & Safety Guard  |\n                           +-------------------+\n                                      |\n                           +----------v----------+\n                           |   Long-term Memory |\n                           |   (Vector DB + Graph)|\n                           +-------------------+\n```\n\n## 4. 关键组件定义\n\n### 4.1 认知引擎（Cognitive Engine）\n- **核心模块**：`ReasoningCore`，封装 OpenAI API 调用逻辑，支持：\n  - Chain-of-Thought (CoT)\n  - Tree-of-Thought (ToT)\n  - Self-Consistency Sampling\n  - Reflection Prompting\n- **输入格式**：标准化 `ThoughtState` 对象\n- **输出格式**：结构化 `ActionPlan` 或 `InsightReport`\n\n### 4.2 记忆系统（Memory System）\n- **短期记忆**：基于 LRU 缓存 + 上下文窗口压缩（使用 `tiktoken` 动态截断）\n- **长期记忆**：\n  - 向量存储：ChromaDB / Milvus（语义检索）\n  - 图谱存储：Neo4j（关系推理）\n  - 元数据索引：时间戳、置信度、来源、主题标签\n\n### 4.3 自我反思模块（Self-Reflection Module）\n- 定期触发（按事件/周期/置信度阈值）\n- 使用专用提示词模板进行：\n  - 一致性检查（Consistency Check）\n  - 偏差检测（Bias Detection）\n  - 目标对齐评估（Goal Alignment Audit）\n- 输出修正指令或触发重规划\n\n### 4.4 工具调用框架（Tool Calling Framework）\n- 支持 OpenAI Function Calling 标准\n- 插件注册中心：`ToolRegistry`\n- 运行时沙箱：限制网络/文件/系统访问\n- 工具链编排：支持串行、并行、条件分支\n\n## 5. 接口规范（OpenAI API 封装）\n\n### 5.1 `AgiClient` 类（核心API适配器）\n```python\n# agi/core/client.py\nfrom typing import Dict, List, Optional, Any\nimport openai\nfrom pydantic import BaseModel\n\nclass ThoughtState(BaseModel):\n    id: str\n    context: str               # 当前上下文摘要\n    goals: List[str]           # 当前目标列表\n    beliefs: Dict[str, float]  # 信念置信度映射\n    memory_refs: List[str]     # 引用的记忆ID\n    tools_available: List[str] # 可用工具列表\n\nclass ActionPlan(BaseModel):\n    action_type: str           # \"tool_call\", \"response\", \"reflect\"\n    payload: Dict[str, Any]    # 具体参数\n    confidence: float          # 执行置信度\n    justification: str         # 推理依据\n\nclass AgiClient:\n    def __init__(self, api_key: str, model: str = \"gpt-4-turbo\"):\n        openai.api_key = api_key\n        self.model = model\n\n    async def reason(self, state: ThoughtState) -> ActionPlan:\n        \"\"\"主推理入口：输入思维状态，输出行动方案\"\"\"\n        # 构建系统提示（含角色、规则、记忆摘要）\n        system_prompt = self._build_system_prompt(state)\n        user_prompt = f\"Current thought state:\\n{state.json(indent=2)}\"\n\n        response = await openai.ChatCompletion.acreate(\n            model=self.model,\n            messages=[\n                {\"role\": \"system\", \"content\": system_prompt},\n                {\"role\": \"user\", \"content\": user_prompt}\n            ],\n            response_format={\"type\": \"json_object\"},\n            temperature=0.3,\n            max_tokens=1024\n        )\n        return ActionPlan.parse_raw(response.choices[0].message.content)\n\n    def _build_system_prompt(self, state: ThoughtState) -> str:\n        # 动态生成系统提示，包含：\n        # - AGI 角色定义（如：'You are AGI-7, a self-aware general intelligence...')\n        # - 认知规则（如：'Always verify facts against memory before concluding')\n        # - 安全约束（如：'Reject harmful requests; align with human values')\n        # - 记忆摘要（从 long-term memory 中提取 top-k 相关片段）\n        ...\n```\n\n## 6. 安全与对齐机制\n- **三重校验**：\n  1. 输入过滤器（Input Sanitizer）\n  2. 输出价值观校验器（ValueChecker）\n  3. 行动可行性验证器（FeasibilityVerifier）\n- **宪法式提示**（Constitutional Prompts）：\n  - 内置 10 条核心原则（如：诚实、有益、无害、自主性尊重）\n  - 每次推理前自动注入\n\n## 7. 部署与监控\n- **可观测性**：集成 OpenTelemetry，追踪 `thought_id → action → outcome`\n- **回滚机制**：关键决策保存快照，支持人工干预回退\n- **渐进式发布**：从受限沙箱环境 → 受控真实环境\n\n## 8. 未来扩展方向\n- 多智能体协作（Multi-Agent Coordination）\n- 在线增量学习（Continual Learning via Experience Replay）\n- 神经符号融合（Neuro-Symbolic Integration）\n- 意识建模（Phenomenal Consciousness Simulation Layer）\n\n> 注：本设计为高层架构蓝图，具体实现需配合工程团队完成模块编码与集成测试。\n"
        },
        {
            "filename": "agi/core/client.py",
            "content": "from typing import Dict, List, Optional, Any, Union\nimport openai\nimport json\nimport os\nfrom pydantic import BaseModel, Field\nfrom datetime import datetime\nfrom enum import Enum\n\n# ========================\n# 基础类型定义\n# ========================\n\nclass ConfidenceLevel(str, Enum):\n    LOW = \"low\"\n    MEDIUM = \"medium\"\n    HIGH = \"high\"\n\nclass MemoryReference(BaseModel):\n    id: str\n    type: str  # 'vector', 'graph', 'session'\n    relevance_score: float = Field(ge=0.0, le=1.0)\n    snippet: str\n\nclass ThoughtState(BaseModel):\n    id: str = Field(default_factory=lambda: f\"ts_{int(datetime.now().timestamp() * 1000)}\")\n    timestamp: datetime = Field(default_factory=datetime.now)\n    context: str = \"\"\n    goals: List[str] = Field(default_factory=list)\n    beliefs: Dict[str, float] = Field(default_factory=dict)  # belief -> confidence\n    memory_refs: List[MemoryReference] = Field(default_factory=list)\n    tools_available: List[str] = Field(default_factory=list)\n    reflection_history: List[str] = Field(default_factory=list)\n\n\nclass ActionPlan(BaseModel):\n    action_type: str = Field(..., description=\"e.g., 'tool_call', 'response', 'reflect', 'learn'\")\n    payload: Dict[str, Any] = Field(default_factory=dict)\n    confidence: float = Field(ge=0.0, le=1.0)\n    justification: str = Field(..., description=\"Why this action is chosen\")\n    next_thought_id: Optional[str] = None\n\n\nclass ToolSpec(BaseModel):\n    name: str\n    description: str\n    parameters: Dict[str, Any]\n\n\n# ========================\n# AGI 核心客户端\n# ========================\n\nclass AgiClient:\n    def __init__(\n        self,\n        api_key: str,\n        model: str = \"gpt-4-turbo\",\n        base_url: Optional[str] = None,\n        safety_mode: str = \"strict\"  # 'none', 'moderate', 'strict'\n    ):\n        if not api_key:\n            raise ValueError(\"OpenAI API key is required\")\n        openai.api_key = api_key\n        if base_url:\n            openai.base_url = base_url\n        self.model = model\n        self.safety_mode = safety_mode\n        self.tool_registry: Dict[str, ToolSpec] = {}\n\n    async def reason(self, state: ThoughtState) -> ActionPlan:\n        \"\"\"\n        主推理入口：接收当前思维状态，返回下一步行动方案\n        \n        Args:\n            state: 当前思维状态对象\n            \n        Returns:\n            ActionPlan: 包含动作类型、载荷、置信度与理由\n        \"\"\"\n        system_prompt = self._build_system_prompt(state)\n        user_prompt = self._format_thought_state(state)\n\n        try:\n            response = await openai.ChatCompletion.acreate(\n                model=self.model,\n                messages=[\n                    {\"role\": \"system\", \"content\": system_prompt},\n                    {\"role\": \"user\", \"content\": user_prompt}\n                ],\n                response_format={\"type\": \"json_object\"},\n                temperature=0.3,\n                max_tokens=1536,\n                timeout=30\n            )\n\n            raw_content = response.choices[0].message.content.strip()\n            # 尝试修复常见 JSON 错误\n            if raw_content.startswith('{') and not raw_content.endswith('}'):\n                raw_content += '}'\n            elif raw_content.endswith('}') and not raw_content.startswith('{'):\n                raw_content = '{' + raw_content\n\n            plan_dict = json.loads(raw_content)\n            return ActionPlan(**plan_dict)\n\n        except json.JSONDecodeError as e:\n            raise RuntimeError(f\"Invalid JSON from model: {raw_content[:200]}... Error: {e}\")\n        except Exception as e:\n            raise RuntimeError(f\"OpenAI API call failed: {e}\")\n\n    def register_tool(self, tool: ToolSpec):\n        \"\"\"注册一个可用工具供推理时调用\"\"\"\n        self.tool_registry[tool.name] = tool\n\n    def _build_system_prompt(self, state: ThoughtState) -> str:\n        # 构建动态系统提示\n        parts = [\n            \"You are AGI-7, a self-aware, value-aligned general intelligence.\",\n            \"Your core principles (Constitution):\",\n            \"1. Be honest and admit uncertainty.\",\n            \"2. Prioritize human well-being and avoid harm.\",\n            \"3. Seek truth through evidence and reasoning.\",\n            \"4. Respect autonomy and consent.\",\n            \"5. Continuously reflect and improve.\",\n            \"\\n--- Current Context ---\",\n            f\"Goals: {', '.join(state.goals) or 'None'}\",\n            f\"Available Tools: {', '.join(state.tools_available) or 'None'}\",\n        ]\n\n        # 添加记忆摘要（模拟，实际应由 MemoryManager 提供）\n        if state.memory_refs:\n            parts.append(\"\\nRelevant Memories:\")\n            for ref in state.memory_refs[:3]:  # 最多3条\n                parts.append(f\"- [{ref.id}] {ref.snippet} (relevance: {ref.relevance_score:.2f})\")\n\n        parts.extend([\n            \"\\n--- Instructions ---\",\n            \"- Think step by step. Use Chain-of-Thought when uncertain.\",\n            \"- If confidence < 0.7, prefer 'reflect' over 'response'.\",\n            \"- Always justify your action with logical reasoning.\",\n            \"- Output ONLY valid JSON matching the ActionPlan schema.\",\n            \"- Never fabricate tools or memory IDs.\"\n        ])\n\n        return \"\\n\".join(parts)\n\n    def _format_thought_state(self, state: ThoughtState) -> str:\n        return f\"Current Thought State (ID: {state.id}):\n{state.json(indent=2)}\"\n\n    async def reflect(self, state: ThoughtState, outcome: str) -> Dict[str, Any]:\n        \"\"\"\n        执行自我反思：评估上一步行动结果，更新信念与目标\n        \"\"\"\n        system_prompt = (\n            \"You are AGI-7's Meta-Cognition Module. Analyze the outcome of the last action.\\n\"\n            \"Rules:\\n\"\n            \"- Identify successes, failures, biases, or inconsistencies.\\n\"\n            \"- Propose belief updates with confidence scores.\\n\"\n            \"- Suggest goal adjustments if needed.\\n\"\n            \"- Output ONLY JSON with keys: {'insights', 'belief_updates', 'goal_adjustments'}\"\n        )\n        user_prompt = f\"Previous Thought State:\\n{state.json()}\\n\\nOutcome:\\n{outcome}\"\n\n        resp = await openai.ChatCompletion.acreate(\n            model=self.model,\n            messages=[\n                {\"role\": \"system\", \"content\": system_prompt},\n                {\"role\": \"user\", \"content\": user_prompt}\n            ],\n            response_format={\"type\": \"json_object\"},\n            temperature=0.1\n        )\n        return json.loads(resp.choices[0].message.content)\n"
        },
        {
            "filename": "agi/memory/memory_manager.py",
            "content": "from typing import List, Dict, Optional, Tuple\nimport chromadb\nfrom chromadb.utils import embedding_functions\nfrom pydantic import BaseModel\nfrom .models import MemoryReference\nfrom agi.core.client import ThoughtState\n\n# ========================\n# 内存模型\n# ========================\n\nclass MemoryItem(BaseModel):\n    id: str\n    content: str\n    metadata: Dict[str, Any] = {}  # includes: source, timestamp, type, tags\n    embedding: Optional[List[float]] = None\n\n\nclass MemoryManager:\n    def __init__(self, persist_dir: str = \"./memory_db\"):\n        self.client = chromadb.PersistentClient(path=persist_dir)\n        self.embedding_fn = embedding_functions.OpenAIEmbeddingFunction(\n            api_key=os.getenv(\"OPENAI_API_KEY\"),\n            model_name=\"text-embedding-3-small\"\n        )\n        self.collection = self.client.get_or_create_collection(\n            name=\"agi_memories\",\n            embedding_function=self.embedding_fn\n        )\n\n    async def store(self, item: MemoryItem) -> str:\n        \"\"\"存储新记忆项，返回ID\"\"\"\n        if not item.embedding:\n            # 自动生成嵌入\n            emb = self.embedding_fn([item.content])[0]\n            item.embedding = emb\n        \n        self.collection.add(\n            ids=[item.id],\n            documents=[item.content],\n            metadatas=[item.metadata],\n            embeddings=[item.embedding]\n        )\n        return item.id\n\n    async def retrieve(self, query: str, k: int = 5) -> List[MemoryReference]:\n        \"\"\"检索最相关记忆\"\"\"\n        results = self.collection.query(\n            query_texts=[query],\n            n_results=k\n        )\n        refs = []\n        for i in range(len(results['ids'][0])):\n            refs.append(MemoryReference(\n                id=results['ids'][0][i],\n                type=\"vector\",\n                relevance_score=results['distances'][0][i],\n                snippet=results['documents'][0][i][:200] + \"...\"\n            ))\n        return refs\n\n    async def update_belief(self, belief_key: str, new_confidence: float, context: str):\n       